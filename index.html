import React, { useState, useRef, useEffect } from 'react';
import { Play, Pause, Music, HelpCircle, CheckCircle, XCircle, Copy, RotateCcw, ExternalLink, QrCode, Disc } from 'lucide-react';

const App = () => {
  // --- 게임 설정 (여기서 모든 내용을 수정하세요!) ---
  const GAME_CONFIG = {
    trackAUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
    trackBUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
    correctAnswer: 'A', // 정답: 'A' 또는 'B'
    promptText: "A futuristic city pop track with heavy synth bass, upbeat tempo, and female vocals dreaming of electric sheep."
  };

  // --- 상태 관리 ---
  const [gameState, setGameState] = useState('listening'); // listening, guessing, result, outro
  const [playedTracks, setPlayedTracks] = useState({ A: false, B: false });
  const [isPlaying, setIsPlaying] = useState(null); // 'A', 'B', or null
  const [isCorrect, setIsCorrect] = useState(false);
  const [copied, setCopied] = useState(false);

  // --- 오디오 레퍼런스 ---
  const audioARef = useRef(new Audio(GAME_CONFIG.trackAUrl));
  const audioBRef = useRef(new Audio(GAME_CONFIG.trackBUrl));

  // --- 오디오 제어 로직 ---
  const togglePlay = (track) => {
    const targetAudio = track === 'A' ? audioARef.current : audioBRef.current;
    const otherAudio = track === 'A' ? audioBRef.current : audioARef.current;

    // 다른 트랙이 재생 중이면 멈춤
    if (isPlaying && isPlaying !== track) {
      otherAudio.pause();
      otherAudio.currentTime = 0;
    }

    if (isPlaying === track) {
      targetAudio.pause();
      setIsPlaying(null);
    } else {
      // 재생 시도
      targetAudio.play().catch(e => console.error("Play error:", e));
      setIsPlaying(track);
      setPlayedTracks(prev => ({ ...prev, [track]: true }));
    }
  };

  // 오디오 이벤트 리스너 & 클린업
  useEffect(() => {
    const handleEnded = () => setIsPlaying(null);
    const audioA = audioARef.current;
    const audioB = audioBRef.current;

    audioA.addEventListener('ended', handleEnded);
    audioB.addEventListener('ended', handleEnded);

    return () => {
      audioA.pause();
      audioB.pause();
      audioA.removeEventListener('ended', handleEnded);
      audioB.removeEventListener('ended', handleEnded);
    };
  }, []);

  // --- 이벤트 핸들러 ---
  const handleGuess = (choice) => {
    audioARef.current.pause();
    audioBRef.current.pause();
    setIsPlaying(null);

    const isAnswerCorrect = choice === GAME_CONFIG.correctAnswer;
    setIsCorrect(isAnswerCorrect);
    setGameState('result');
  };

  const handleContinue = () => {
    setGameState('outro');
  };

  const handleCopyPrompt = () => {
    navigator.clipboard.writeText(GAME_CONFIG.promptText).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    });
  };

  const handleReset = () => {
    audioARef.current.currentTime = 0;
    audioBRef.current.currentTime = 0;
    setPlayedTracks({ A: false, B: false });
    setGameState('listening');
    setIsPlaying(null);
    setIsCorrect(false);
  };

  const allPlayed = playedTracks.A && playedTracks.B;
  const canVote = allPlayed && isPlaying === null;

  // --- UI 렌더링 ---
  return (
    <div className="min-h-screen bg-black text-white font-['Pretendard'] tracking-tight flex items-center justify-center p-4 lg:p-8">
      
      {/* 폰트 로드 */}
      <style>{`
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");
        body { font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { bg: #121212; }
        ::-webkit-scrollbar-thumb { background: #5a5a5a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
      `}</style>

      {/* 메인 컨테이너 */}
      <div className="w-full max-w-7xl bg-[#121212] rounded-[32px] overflow-hidden shadow-2xl flex flex-col lg:flex-row min-h-[85vh] ring-1 ring-[#333]">
        
        {/* --- 좌측 패널: 메인 인터랙션 영역 --- */}
        <div className="flex-1 lg:flex-[2.2] p-8 lg:p-16 flex flex-col relative bg-gradient-to-b from-[#2a2a2a] to-[#121212]">
          
          {/* Header */}
          <header className="flex items-center justify-between mb-12">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center">
                <Disc size={24} className="animate-spin-slow" style={{ animationDuration: '4s' }} />
              </div>
              <h1 className="text-xl font-bold tracking-tighter">AI Music Test</h1>
            </div>
          </header>

          {/* Main Content Area */}
          <div className="flex-1 flex flex-col justify-center items-center w-full">
            
            {(gameState === 'listening' || gameState === 'guessing') && (
              <div className="w-full max-w-4xl space-y-12 animate-fade-in">
                <div className="space-y-3">
                  <h2 className="text-4xl lg:text-6xl font-black leading-tight tracking-tighter">
                    {canVote ? "Real vs AI" : "Listen & Compare"}
                  </h2>
                  <p className="text-[#b3b3b3] text-lg lg:text-xl font-medium">
                    {canVote ? "어떤 트랙이 AI가 만든 음악일까요?" : "두 트랙을 감상하고 AI가 만든 곡을 찾아보세요."}
                  </p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Track A Card */}
                  <div className={`
                      group relative bg-[#181818] hover:bg-[#282828] rounded-xl p-6 transition-all duration-300 cursor-pointer
                      ${isPlaying === 'A' ? 'bg-[#282828]' : ''}
                    `}>
                    <div className="relative aspect-square mb-6 bg-[#333] rounded shadow-lg overflow-hidden group-hover:shadow-2xl transition-shadow">
                       <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                          <span className="text-6xl font-black opacity-20 text-black">A</span>
                       </div>
                       
                       <div className={`
                         absolute bottom-4 right-4 w-12 h-12 bg-[#1DB954] rounded-full flex items-center justify-center shadow-xl text-black
                         transform transition-all duration-300 translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100
                         ${isPlaying === 'A' ? 'translate-y-0 opacity-100 scale-110' : ''}
                       `}>
                          <button onClick={() => togglePlay('A')} className="w-full h-full flex items-center justify-center">
                            {isPlaying === 'A' ? <Pause fill="black" size={20} /> : <Play fill="black" size={20} className="ml-1" />}
                          </button>
                       </div>
                    </div>
                    
                    <div className="space-y-1">
                      <h3 className={`text-xl font-bold ${isPlaying === 'A' ? 'text-[#1DB954]' : 'text-white'}`}>Track A</h3>
                      <p className="text-[#b3b3b3] text-sm font-medium">Unknown Artist</p>
                    </div>

                    {canVote && (
                      <button 
                        onClick={() => handleGuess('A')}
                        className="mt-6 w-full py-3 rounded-full border border-[#777] hover:border-white hover:scale-[1.02] font-bold text-sm tracking-wide uppercase transition-all animate-fade-in"
                      >
                        Track A 선택
                      </button>
                    )}
                  </div>

                  {/* Track B Card */}
                  <div className={`
                      group relative bg-[#181818] hover:bg-[#282828] rounded-xl p-6 transition-all duration-300 cursor-pointer
                      ${isPlaying === 'B' ? 'bg-[#282828]' : ''}
                    `}>
                    <div className="relative aspect-square mb-6 bg-[#333] rounded shadow-lg overflow-hidden group-hover:shadow-2xl transition-shadow">
                       <div className="absolute inset-0 bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center">
                          <span className="text-6xl font-black opacity-20 text-black">B</span>
                       </div>
                       
                       <div className={`
                         absolute bottom-4 right-4 w-12 h-12 bg-[#1DB954] rounded-full flex items-center justify-center shadow-xl text-black
                         transform transition-all duration-300 translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100
                         ${isPlaying === 'B' ? 'translate-y-0 opacity-100 scale-110' : ''}
                       `}>
                          <button onClick={() => togglePlay('B')} className="w-full h-full flex items-center justify-center">
                            {isPlaying === 'B' ? <Pause fill="black" size={20} /> : <Play fill="black" size={20} className="ml-1" />}
                          </button>
                       </div>
                    </div>

                    <div className="space-y-1">
                      <h3 className={`text-xl font-bold ${isPlaying === 'B' ? 'text-[#1DB954]' : 'text-white'}`}>Track B</h3>
                      <p className="text-[#b3b3b3] text-sm font-medium">Unknown Artist</p>
                    </div>

                    {canVote && (
                      <button 
                        onClick={() => handleGuess('B')}
                        className="mt-6 w-full py-3 rounded-full border border-[#777] hover:border-white hover:scale-[1.02] font-bold text-sm tracking-wide uppercase transition-all animate-fade-in"
                      >
                        Track B 선택
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )}

            {gameState === 'outro' && (
              <div className="w-full max-w-2xl space-y-10 animate-fade-in text-center">
                <div className="space-y-4">
                  <span className="text-[#1DB954] font-bold tracking-widest text-xs uppercase">Create Your Own</span>
                  <h2 className="text-4xl lg:text-5xl font-black">
                    Suno로 시작하기
                  </h2>
                  <p className="text-[#b3b3b3] text-lg max-w-lg mx-auto leading-relaxed">
                    Track {GAME_CONFIG.correctAnswer}는 Suno AI로 생성되었습니다. <br/>아래 프롬프트를 복사해 나만의 음악을 만들어보세요.
                  </p>
                </div>

                <div className="bg-[#282828] rounded-xl p-6 text-left group hover:bg-[#333] transition-colors relative">
                   <div className="flex justify-between items-start mb-2">
                     <span className="text-xs font-bold text-[#b3b3b3] uppercase tracking-wider">Prompt</span>
                     <button 
                        onClick={handleCopyPrompt}
                        className="text-white hover:text-[#1DB954] transition-colors"
                      >
                        {copied ? <CheckCircle size={20} className="text-[#1DB954]" /> : <Copy size={20} />}
                      </button>
                   </div>
                   <p className="text-lg font-medium leading-normal text-white">
                    "{GAME_CONFIG.promptText}"
                   </p>
                   {copied && <div className="absolute top-0 right-0 m-6 mr-10 bg-[#1DB954] text-black text-xs font-bold px-2 py-1 rounded">복사완료</div>}
                </div>

                <div className="flex flex-col sm:flex-row gap-4 justify-center pt-4">
                  <a 
                    href="https://suno.com" 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="flex-1 py-4 px-8 bg-white text-black rounded-full font-bold text-sm tracking-widest uppercase hover:scale-105 transition-transform flex items-center justify-center gap-2"
                  >
                    Suno 열기 <ExternalLink size={16} />
                  </a>
                  <button 
                    onClick={handleReset}
                    className="flex-1 py-4 px-8 bg-transparent border border-[#777] hover:border-white text-white rounded-full font-bold text-sm tracking-widest uppercase hover:scale-105 transition-transform"
                  >
                    처음으로 돌아가기
                  </button>
                </div>
              </div>
            )}

          </div>
        </div>

        {/* --- 우측 패널: QR 코드 (Sidebar) --- */}
        <div className="hidden lg:flex lg:flex-1 bg-black flex-col p-12 relative overflow-hidden">
          <div className="absolute top-[-20%] right-[-20%] w-[500px] h-[500px] bg-[#1DB954] rounded-full blur-[120px] opacity-10 pointer-events-none"></div>

          <div className="h-full flex flex-col justify-end space-y-8 relative z-10">
            <div className="space-y-2">
              <h2 className="text-3xl font-black tracking-tight leading-tight">
                모바일로<br/>체험해보세요
              </h2>
              <p className="text-[#b3b3b3] font-medium">
                QR코드를 스캔하여 모바일에서<br/>이 경험을 즐겨보세요.
              </p>
            </div>

            <div className="bg-[#181818] p-6 rounded-2xl w-fit shadow-2xl border border-[#333]">
              <div className="w-48 h-48 bg-white rounded flex flex-col items-center justify-center text-black">
                {/* [배포 후 QR코드 설정법]
                  1. 이 앱을 배포하고 URL을 얻습니다 (예: my-app.vercel.app).
                  2. 'qrcode.react' 같은 라이브러리를 쓰거나, 인터넷 무료 QR 생성기에서 이미지를 받아 아래 img 태그에 넣으세요.
                  3. <img src="QR이미지주소" alt="QR Code" className="w-full h-full object-contain" /> 
                */}
                <QrCode size={64} className="opacity-20 mb-2" />
                <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">QR 코드</span>
              </div>
            </div>
          </div>
        </div>

      </div>

      {/* --- 모달 (Result) --- */}
      {gameState === 'result' && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in">
          <div className="bg-[#181818] p-10 rounded-[24px] max-w-md w-full shadow-2xl text-center space-y-8 border border-[#333]">
            
            <div className="flex justify-center">
              {isCorrect ? (
                 <div className="w-24 h-24 rounded-full bg-[#1DB954] flex items-center justify-center text-black shadow-[0_0_40px_rgba(29,185,84,0.4)]">
                   <CheckCircle size={48} strokeWidth={3} />
                 </div>
              ) : (
                 <div className="w-24 h-24 rounded-full bg-[#E91429] flex items-center justify-center text-white shadow-[0_0_40px_rgba(233,20,41,0.4)]">
                   <XCircle size={48} strokeWidth={3} />
                 </div>
              )}
            </div>

            <div className="space-y-2">
              <h3 className="text-3xl font-black tracking-tighter">
                {isCorrect ? "정답입니다!" : "오답입니다"}
              </h3>
              <p className="text-[#b3b3b3] text-lg">
                AI가 생성한 트랙은 <span className="text-white font-bold underline decoration-[#1DB954] decoration-4 underline-offset-4">Track {GAME_CONFIG.correctAnswer}</span>였습니다.
              </p>
            </div>

            <button 
              onClick={handleContinue}
              className="w-full py-4 bg-white text-black rounded-full font-bold text-sm tracking-widest uppercase hover:scale-105 transition-transform"
            >
              계속하기
            </button>
          </div>
        </div>
      )}

      {/* 애니메이션 유틸리티 */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        .animate-spin-slow {
          animation: spin 8s linear infinite;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
};

export default App;